```sql
CREATE OR REPLACE TRIGGER "TRG_COM_PATIENTINFO_INSERT"
  after insert OR update on "HIS50"."COM_PATIENTINFO"
  for each row
declare
  card_no         VARCHAR2(10);
  ic_cardno       VARCHAR2(20);
  name            VARCHAR2(30);
  spell_code      VARCHAR2(30);
  wb_code         VARCHAR2(30);
  birthday        DATE;
  sex_code        VARCHAR2(1);
  idenno          VARCHAR2(18);
  blood_code      VARCHAR2(2);
  prof_code       VARCHAR2(4);
  work_home       VARCHAR2(50);
  work_tel        VARCHAR2(30);
  work_zip        VARCHAR2(6);
  home            VARCHAR2(200);
  home_tel        VARCHAR2(30);
  home_zip        VARCHAR2(6);
  district        VARCHAR2(50);
  nation_code     VARCHAR2(2);
  linkman_name    VARCHAR2(30);
  linkman_tel     VARCHAR2(30);
  linkman_add     VARCHAR2(50);
  rela_code       VARCHAR2(3);
  mari            VARCHAR2(1);
  coun_code       VARCHAR2(3);
  paykind_code    VARCHAR2(2);
  paykind_name    VARCHAR2(50);
  pact_code       VARCHAR2(10);
  pact_name       VARCHAR2(50);
  mcard_no        VARCHAR2(100);
  area_code       VARCHAR2(30);
  framt           NUMBER(9,2);
  anaphy_flag     VARCHAR2(1);
  hepatitis_flag  VARCHAR2(1);
  act_code        VARCHAR2(8);
  act_amt         NUMBER(9,2);
  lact_sum        NUMBER(9,2);
  lbank_sum       NUMBER(9,2);
  arrear_times    NUMBER(2);
  arrear_sum      NUMBER(9,2);
  inhos_source    VARCHAR2(1);
  lihos_date      DATE;
  inhos_times     NUMBER(3);
  louthos_date    DATE;
  fir_see_date    DATE;
  lreg_date       DATE;
  disoby_cnt      NUMBER;
  end_date        DATE;
  mark            VARCHAR2(2000);
  oper_code       VARCHAR2(6) ;
  oper_date       DATE;
  is_valid        VARCHAR2(1);
  fee_kind        VARCHAR2(2);
  old_cardno      VARCHAR2(30);
  is_encryptname  VARCHAR2(1);
  normalname      VARCHAR2(50);
  idcardtype      VARCHAR2(2);
  vip_flag        VARCHAR2(1);
  monther_name    VARCHAR2(20);
  is_treatment    VARCHAR2(1);
  case_no         VARCHAR2(10);
  insurance_id    VARCHAR2(2);
  insurance_name  VARCHAR2(50);
  home_door_no    VARCHAR2(40);
  linkman_door_no VARCHAR2(40);
  email           VARCHAR2(50);
  emr_patid       NUMBER(16);
  province        VARCHAR2(20);
  city            VARCHAR2(20);
  area            VARCHAR2(20);
  road            VARCHAR2(100);
  province1       VARCHAR2(20);
  city1           VARCHAR2(20);
  area1           VARCHAR2(20);
  province2       VARCHAR2(20);
  city2           VARCHAR2(20);
  area2           VARCHAR2(20);
  road1           VARCHAR2(100);
  province3       VARCHAR2(20);
  city3           VARCHAR2(20);
  area3           VARCHAR2(20);
  out_mark        VARCHAR2(2000);
begin
  card_no :=:new.card_no;
  ic_cardno :=:new.ic_cardno;
  name  :=:new.name;
  spell_code  :=:new.spell_code;
  wb_code     :=:new.wb_code;
  birthday      :=:new.birthday;
  sex_code      :=:new.sex_code;
  idenno        :=:new.idenno;
  blood_code     :=:new.blood_code;
  prof_code       :=:new.prof_code;
  work_home      :=:new.work_home;
  work_tel        :=:new.work_tel;
  work_zip         :=:new.work_zip;
  home            :=:new.home;
  home_tel        :=:new.home_tel;
  home_zip         :=:new.home_zip;
  district        :=:new.district;
  nation_code     :=:new.nation_code;
  linkman_name     :=:new.linkman_name;
  linkman_tel     :=:new.linkman_tel;
  linkman_add     :=:new.linkman_add;
  rela_code        :=:new.rela_code;
  mari            :=:new.mari;
  coun_code        :=:new.coun_code;
  paykind_code     :=:new.paykind_code;
  paykind_name     :=:new.paykind_name;
  pact_code        :=:new.pact_code;
  pact_name        :=:new.pact_name;
  mcard_no         :=:new.mcard_no;
  area_code       :=:new.area_code;
  framt            :=:new.framt;
  anaphy_flag      :=:new.anaphy_flag;
  hepatitis_flag   :=:new.hepatitis_flag;
  act_code        :=:new.act_code;
  act_amt         :=:new.act_amt;
  lact_sum        :=:new.lact_sum;
  lbank_sum       :=:new.lbank_sum;
  arrear_times    :=:new.arrear_times;
  arrear_sum       :=:new.arrear_sum;
  inhos_source    :=:new.inhos_source;
  lihos_date       :=:new.lihos_date;
  inhos_times      :=:new.inhos_times;
  louthos_date    :=:new.louthos_date;
  fir_see_date     :=:new.fir_see_date;
  lreg_date       :=:new.lreg_date;
  disoby_cnt       :=:new.disoby_cnt;
  end_date        :=:new.end_date;
  mark            :=:new.mark;
  oper_code        :=:new.oper_code;
  oper_date       :=:new.oper_date;
  is_valid        :=:new.is_valid;
  fee_kind         :=:new.fee_kind;
  old_cardno      :=:new.old_cardno;
  is_encryptname   :=:new.is_encryptname;
  normalname       :=:new.normalname;
  idcardtype       :=:new.idcardtype;
  vip_flag        :=:new.vip_flag;
  monther_name     :=:new.monther_name;
  is_treatment     :=:new.is_treatment;
  case_no          :=:new.case_no;
  insurance_id     :=:new.insurance_id;
  insurance_name   :=:new.insurance_name;
  home_door_no     :=:new.home_door_no;
  linkman_door_no  :=:new.linkman_door_no;
  email           :=:new.email;
  emr_patid        :=:new.emr_patid;
  province        :=:new.province;
  city             :=:new.city;
  area             :=:new.area;
  road            :=:new.road;
  province1        :=:new.province1;
  city1            :=:new.city1;
  area1            :=:new.area1;
  province2       :=:new.province2;
  city2            :=:new.city2;
  area2            :=:new.area2;
  road1            :=:new.road1;
  province3       :=:new.province3;
  city3            :=:new.city3;
  area3           :=:new.area3;
  out_mark            :=:new.out_mark;

  if inserting then
    insert into com_patientinfo_record
    (card_no, ic_cardno, name, spell_code, wb_code, birthday, sex_code, idenno, blood_code, prof_code, work_home, work_tel, work_zip, home, home_tel, home_zip, district, nation_code, linkman_name, linkman_tel, linkman_add, rela_code, mari, coun_code, paykind_code, paykind_name, pact_code, pact_name, mcard_no, area_code, framt, anaphy_flag, hepatitis_flag, act_code, act_amt, lact_sum, lbank_sum, arrear_times, arrear_sum, inhos_source, lihos_date, inhos_times, louthos_date, fir_see_date, lreg_date, disoby_cnt, end_date, mark, oper_code, oper_date, is_valid, fee_kind, old_cardno, is_encryptname, normalname, idcardtype, vip_flag, monther_name, is_treatment, case_no, insurance_id, insurance_name, home_door_no, linkman_door_no, email, emr_patid, province, city, area, road, province1, city1, area1, province2, city2, area2, road1, province3, city3, area3, out_mark, modifytype)
     values
    (card_no, ic_cardno, name, spell_code, wb_code, birthday, sex_code, idenno, blood_code, prof_code, work_home, work_tel, work_zip, home, home_tel, home_zip, district, nation_code, linkman_name, linkman_tel, linkman_add, rela_code, mari, coun_code, paykind_code, paykind_name, pact_code, pact_name, mcard_no, area_code, framt, anaphy_flag, hepatitis_flag, act_code, act_amt, lact_sum, lbank_sum, arrear_times, arrear_sum, inhos_source, lihos_date, inhos_times, louthos_date, fir_see_date, lreg_date, disoby_cnt, end_date, mark, oper_code, sysdate, is_valid, fee_kind, old_cardno, is_encryptname, normalname, idcardtype, vip_flag, monther_name, is_treatment, case_no, insurance_id, insurance_name, home_door_no, linkman_door_no, email, emr_patid, province, city, area, road, province1, city1, area1, province2, city2, area2, road1, province3, city3, area3, out_mark, '新增');
  end if;
  if updating then
    if :new.card_no <> :old.card_no or :new.name<>:old.name or :new.birthday<>:old.birthday or :new.sex_code<>:old.sex_code
      or :new.idenno<>:old.ic_cardno or :new.work_home<>:old.work_home or :new.home_tel<>:old.home_tel or :new.home<>:old.home
      or :new.paykind_code<>:old.paykind_code or :new.pact_code<>:old.pact_code or :new.out_mark<>:old.out_mark then
        insert into com_patientinfo_record
        (card_no, ic_cardno, name, spell_code, wb_code, birthday, sex_code, idenno, blood_code, prof_code, work_home, work_tel, work_zip, home, home_tel, home_zip, district, nation_code, linkman_name, linkman_tel, linkman_add, rela_code, mari, coun_code, paykind_code, paykind_name, pact_code, pact_name, mcard_no, area_code, framt, anaphy_flag, hepatitis_flag, act_code, act_amt, lact_sum, lbank_sum, arrear_times, arrear_sum, inhos_source, lihos_date, inhos_times, louthos_date, fir_see_date, lreg_date, disoby_cnt, end_date, mark, oper_code, oper_date, is_valid, fee_kind, old_cardno, is_encryptname, normalname, idcardtype, vip_flag, monther_name, is_treatment, case_no, insurance_id, insurance_name, home_door_no, linkman_door_no, email, emr_patid, province, city, area, road, province1, city1, area1, province2, city2, area2, road1, province3, city3, area3, out_mark, modifytype)
        values
        (card_no, ic_cardno, name, spell_code, wb_code, birthday, sex_code, idenno, blood_code, prof_code, work_home, work_tel, work_zip, home, home_tel, home_zip, district, nation_code, linkman_name, linkman_tel, linkman_add, rela_code, mari, coun_code, paykind_code, paykind_name, pact_code, pact_name, mcard_no, area_code, framt, anaphy_flag, hepatitis_flag, act_code, act_amt, lact_sum, lbank_sum, arrear_times, arrear_sum, inhos_source, lihos_date, inhos_times, louthos_date, fir_see_date, lreg_date, disoby_cnt, end_date, mark, oper_code, sysdate, is_valid, fee_kind, old_cardno, is_encryptname, normalname, idcardtype, vip_flag, monther_name, is_treatment, case_no, insurance_id, insurance_name, home_door_no, linkman_door_no, email, emr_patid, province, city, area, road, province1, city1, area1, province2, city2, area2, road1, province3, city3, area3, out_mark, '修改');
    end if;
  end if;

end TRG_COM_PATIENTINFO_INSERT;
z

/*==========存储过程-Prc_FixBedPatient【HIS50用户下执行】==========
*/----------HIS-22039----------
create or replace procedure his50.Prc_FixBedPatient

(
    patientInfo in fin_ipr_inmaininfo%rowtype,
    businessDate in Date,
    err out varchar2
)
is
FeeInterval number(2);
bedGrade  varchar2(20); -- 床位等级
Pre_Fixfee_Date Date; --上次记账时间
Fixeddate       Date; --记录当时时间，类似医嘱应执行时间
Fixedtime       Varchar2(9); --记录用来计费的时间
UndrugBranch    varchar2(1);
distcode        varchar2(10);
Tot_Cost        Number;
oldPatient     fin_ipr_inmaininfo%rowtype;
cursor Bed_Item_List(FeeGradeCode varchar2,distCode varchar2) is
  select bg.* from Fin_Com_Bedfeegrade bg--,com_bedinfo c
  where bg.fee_grade_code = FeeGradeCode
  and bg.valid_state = '1'
  and (bg.branch_code = distCode);
  -- and c.clinic_no = patientInfo.inpatient_no

cursor Bed_GradeList(inpatientNo varchar2) is
 select b.* from com_bedinfo b
 where b.clinic_no = inpatientNo
 and b.bed_state in ('O','W');



begin
  if patientInfo.Fee_Interval <= 0 then
    FeeInterval := 1;
    else
      FeeInterval := patientInfo.Fee_Interval;
    end if;
  Tot_Cost :=0;
  select par_value into UndrugBranch from dawn_ctrlparam_info where par_id = 'HB_IsUndrugBranch';
    if UndrugBranch = '1' then
        select branch_code
          into distcode
          from com_department
         where dept_code = patientInfo.nurse_cell_code;
         else
           select t.dist_code into distcode  from dawn_org_dist t where t.main_dist_flag='1';
    end if;

  Begin
      Insert Into Com_Fixed_Fee_Log (Log) Values ('开始处理住院号：' || patientInfo.Inpatient_No);
  End;
  Begin
  Select Max(a.Oper_Date)
    Into Pre_Fixfee_Date
    From Com_Shiftdata a
   Where Clinic_No = patientInfo.Inpatient_No
     And a.Shift_Type IN ('K', 'C');
  End;
  if Pre_Fixfee_Date is null then
    err := '院号：' || patientInfo.Inpatient_No ||'在入出转记录中没有找到接诊或召回记录';
    return;
  end if;
    -- 已经收取过床位费
  if patientInfo.Prefixfee_Date > Pre_Fixfee_Date then
    Fixeddate := To_Date(To_Char(patientInfo.Prefixfee_Date, 'yyyy-mm-dd') || Fixedtime, 'yyyy-mm-dd hh24:mi:ss') + FeeInterval;
    else
    If Pre_Fixfee_Date <= To_Date(To_Char(patientInfo.Prefixfee_Date, 'yyyy-mm-dd') || Fixedtime, 'yyyy-mm-dd hh24:mi:ss') Then
          Fixeddate := To_Date(To_Char(patientInfo.Prefixfee_Date, 'yyyy-mm-dd') || Fixedtime, 'yyyy-mm-dd hh24:mi:ss');
    Else
      --更新上次时间为接诊时间加1秒，便于下次正常执行
      Begin
        --如果定时任务的时间设置的时23：50，那么这里不赋值的话，会导致到零点的10分钟内的入院登记患者，不能自动计费，以后每天都记不上只能手动计费，需要赋值为当前时间
        Fixeddate := To_Date(To_Char(businessDate, 'yyyy-mm-dd') || Fixedtime, 'yyyy-mm-dd hh24:mi:ss');
        Update Fin_Ipr_Inmaininfo Tt Set Tt.Prefixfee_Date = (Pre_Fixfee_Date + 1 / (24 * 60 * 60)) Where Tt.Inpatient_No = patientInfo.Inpatient_No;
      Exception
        When Others Then
          err := '更新住院主表失败:' || Sqlerrm;
          Insert Into Com_Fixed_Fee_Log
            (Log_Type,
             Log)
          Values
            (-1,
             err);
      End;
      --Loopflag := 1;
     -- Goto Nextbed;
     end if;
    End If;
    select b.Fee_Grade_Code into bedGrade from com_bedinfo b where b.bed_no = patientInfo.bed_no ;
        Select To_Char(t.Next_Dtime, ' hh24:mi:ss') Into Fixedtime From Com_Job t Where t.Job_Code = 'FIN_FixFee';
        if bedGrade is null then
        err := '未找到该床位对应床位等级';
        return;
        else
    -- 循环日期收费
    while Fixeddate < (Trunc(businessDate, 'dd') + 1) - 1 / (24 * 60 * 60)
    loop
      begin
       -- begin


       -- end;
        for grade in Bed_GradeList(patientInfo.inpatient_no) loop


         -- begin
        for Bi in Bed_Item_List(grade.Fee_Grade_Code,distcode) loop
          If Bi.Date_Flag = 1 Then --时间相关项目
              If Bi.End_Date < Bi.Begin_Date Then
                --跨年
                If Fixeddate <= To_Date(To_Char(Add_Months(Sysdate, -12), 'yyyy') || To_Char(Bi.Begin_Date, 'mmdd'), 'yyyymmdd')
                   OR Fixeddate >= To_Date(To_Char(Sysdate, 'yyyy') || To_Char(Bi.End_Date, 'mmdd'), 'yyyymmdd') Then
                  continue;
                End If;
              Else
                 If Fixeddate <= to_date(to_char(Bi.Begin_Date,'yyyy-mm-dd'),'yyyy-mm-dd')
                   OR Fixeddate >= to_date(to_char(Bi.End_Date,'yyyy-mm-dd'),'yyyy-mm-dd') Then
                  continue;--有效期外固定费用不收费
                End If;
              End If;
          End If;

          Prc_FixBedItems(patientInfo,Bi,UndrugBranch,trunc(Fixeddate) + 1 - 1 / (24 * 60 * 60),Tot_Cost,err);
           end loop;
         -- end if;
         end loop;


     -- end;

      Fixeddate := Fixeddate + FeeInterval;
      end;
    end loop;
    -- 更新主表费用
      begin
        select *
          into oldPatient
          from fin_ipr_inmaininfo
         where inpatient_no = patientInfo.inpatient_no;
      end;
      oldPatient.Tot_Cost := oldPatient.Tot_Cost + Tot_Cost;
      oldPatient.Own_Cost := oldPatient.Own_Cost + Tot_Cost;
      oldPatient.Free_Cost := oldPatient.Free_Cost - Tot_Cost;
      begin
        update fin_ipr_inmaininfo i
           set i.Tot_Cost=oldPatient.Tot_Cost,
               i.Own_Cost = oldPatient.Own_Cost,
               i.PREFIXFEE_DATE = (Fixeddate - i.Fee_Interval),
               i.free_cost = oldPatient.Free_Cost
         where i.inpatient_no = patientInfo.inpatient_no;
          --记录一下更新主表的金额
         Insert Into Com_Fixed_Fee_Log
            (Log_Type,
             Log)
          Values
            (0,
             '更新后的主表金额：'||'TotCots:'||oldPatient.Tot_Cost||',OwnCost:'||oldPatient.Own_Cost
             ||'更新后的Feeinfo的金额：'||'Tot_Cost:'||Tot_Cost||',Own_Cost:'||Tot_Cost);
      Exception
        When Others Then
          err := '更新住院主表失败:' || Sqlerrm;
          --Rollback To Savepoint a;
          Insert Into Com_Fixed_Fee_Log
            (Log_Type,
             Log)
          Values
            (-1,
             err);
          return;
      end;
      end if;
       Exception
        When Others Then
         -- Fixeddate := Fixeddate + patientInfo.Fee_Interval;
          err := '未找到该床位对应床位等级';
          --Rollback To Savepoint a;
          Insert Into Com_Fixed_Fee_Log
            (Log_Type,
             Log)
          Values
            (-1,
             err);
          return;
 -- end if;
end;


/*==========存储过程-PROC_DcOrder【HIS50用户下执行】==========*/
----------HIS-22026----------
create or replace procedure his50.PROC_DcOrder(rtporder met_ipm_order%ROWTYPE) as

begin

  UPDATE met_ipm_order --医嘱资料档
     SET mo_stat = '3', --医嘱状态,1开立，2审核，3执行，4作废
         date_end = rtporder.date_end, --结束时间
         dc_date = sysdate, --Dc时间
         dc_code = '', --DC原因代码
         dc_name = '分解停止', --DC原因名称
         dc_doccd = rtporder.doc_code, --DC医师代码
         dc_docnm = rtporder.doc_name, --DC医师姓名
         dc_usercd = rtporder.doc_code, --Dc人员代码
         dc_usernm = rtporder.doc_name, --Dc人员名称
         DC_CONFIRM_FLAG = '0', --停止成未审核状态，等待审核
         last_mo_stat = mo_stat
   WHERE mo_order = rtporder.mo_order
     and mo_stat < '3'; --必须有效

  if rtporder.subtbl_flag = '0' then
      UPDATE hit_app.met_ordi_order c --医嘱资料档
         SET c.mo_state = '90',--医嘱状态,1开立，2审核，3执行，4作废
         c.dc_doc = rtporder.doc_code, --lishi 肿瘤现场 需要会写停止医生和停止人 出院结算要用
         c.dc_oper = rtporder.doc_code, --lishi 肿瘤现场 需要会写停止医生和停止人 出院结算要用
         c.dc_date = c.end_date
      WHERE MO_ORDER = rtporder.mark6 and c.mo_state <> '90';
  end if;

exception
  when others then
    rollback;
    procErr1(rtporder,'');
end;


/*==========视图-VIEW_CLI_ITEMLIST【HIS50用户下执行】==========*/
----------HIS-22035----------
CREATE OR REPLACE VIEW HIS50.VIEW_CLI_ITEMLIST AS
select  DEPT_CODE , DRUG_FLAG , SYS_CLASS , FEE_CODE , ITEM_CODE , ITEM_NAME , EN_NAME , PACK_QTY , SPECS , DOSE_CODE , SPELL_CODE , WB_CODE , USER_CODE , CUS_NAME , CUS_SPELL_CODE , CUS_WB_CODE , CUS_USER_CODE , UNIT_PRICE , CHILD_PRICE , SP_PRICE , PACK_UNIT , MIN_UNIT , NOW_STORE , EXE_DEPT , GF_FLAG , USAGE_CODE , FREQ_CODE , DOSE_UNIT , SHENXZ , SHIXZ , ZF , NEEDBESPEAK , BASE_DOSE , CONFIRM_FLAG , SPLIT_TYPE , LACK_FLAG , SPECIAL_CHECK , ONCE_DOSE , OTHER_NAME , OTHER_SPELL , DEFAULT_SAMPLE , OTHER_NAME1 , OTHER_NAME2 , OTHER_NAME3 , SPELL_CODE1 , SPELL_CODE2 , SPELL_CODE3 , WB_CODE1 , WB_CODE2 , WB_CODE3 , INPUT_CODE1 , INPUT_CODE2 , INPUT_CODE3 , YBGB_CODE ,QUALITY,undrugitemmodel
  from (select 'undrug' as dept_code,
       '0' as drug_flag, -- 非药品标志
       a.sys_class as sys_class,
       a.fee_code as fee_code,
       a.item_code as item_code,
       a.item_name as item_name,
       '' as en_name,
       1 as pack_qty,
       a.specs as specs,
       '' as dose_code,
       a.spell_code  as spell_code,
       a.wb_code as wb_code,/*''*/
       a.input_code as user_code,
       a.item_name as cus_name,
        a.spell_code as cus_spell_code,
       a.wb_code as cus_wb_code,/*''*/
       a.input_code as cus_user_code,
       a.unit_price as unit_price,
       a.unit_price1 as child_price,
       a.unit_price2 as sp_price,
       a.stock_unit as pack_unit,
       a.stock_unit as min_unit,
       '0' as now_store,
       nvl(a.exedept_code,'无') as exe_dept,
       '' as gf_flag,
       '' as usage_code,
       '' as freq_code,
       '' as dose_unit,
       SPECIAL_FLAG as shenxz,
       SPECIAL_FLAG1 as shixz,
       SPECIAL_FLAG2 as zf,
       NEEDBESPEAK as needbespeak,
       1 as base_dose,
       nvl(CONFIRM_FLAG,'0') as CONFIRM_FLAG,
       '0' as split_type,
       '0' as LACK_FLAG,
       a.special_flag3 as Special_Check,--特殊检查
       0 as once_dose,
       '' as other_name,
       '' as other_spell,
       a.default_sample as default_sample, --样本
       a.other_name1 as other_name1,
       a.other_name2 as other_name2,
       a.other_name3 as other_name3,
       a.spell_code1 as spell_code1,
       a.spell_code2 as spell_code2,
       a.spell_code3 as spell_code3,
       a.wb_code1 as wb_code1,
       a.wb_code2 as wb_code2,
       a.wb_code3 as wb_code3,
       a.input_code1 as input_code1,
       a.input_code2 as input_code2,
       a.input_code3 as input_code3,
       a.ybgbgj_code as YBGB_CODE,
       '' as QUALITY，
       a.undrugitemmodel
       from fin_com_undruginfo a
       where a.valid_state = fun_get_valid
       and a.UNITFLAG = '0' and a.APPLICABILITYAREA <> '2'
union all
SELECT PHA_STO_SETDEPT.ROOM_CODE as dept_code ,
       '1' as drug_flag, --药品标志
       PHA_COM_BASEINFO.Class_Code as sys_class,
        PHA_COM_BASEINFO.FEE_CODE as fee_code,  --最小费用
       PHA_COM_BASEINFO.DRUG_CODE as item_code,      --药品编码
       (CASE WHEN PHA_COM_BASEINFO.REGULAR_NAME IS NOT NULL THEN PHA_COM_BASEINFO.REGULAR_NAME ELSE PHA_COM_BASEINFO.Trade_Name END) as item_name,    --药品名称【药品已经以通用名为主，因此此处改为优先取通用名20241105 shuai.liu_neu】
       PHA_COM_BASEINFO.English_Name as en_name, --英文名称
       PHA_COM_BASEINFO.PACK_QTY as pack_qty,  --包装数量
       PHA_COM_BASEINFO.SPECS as specs,    --药品规格
       PHA_COM_BASEINFO.DOSE_MODEL_CODE as dose_code,--剂型编码
       PHA_COM_BASEINFO.SPELL_CODE as spell_code,  --商品名拼音码
       PHA_COM_BASEINFO.WB_CODE/*''*/ as wb_code,  --商品名五笔码
       PHA_COM_BASEINFO.CUSTOM_CODE as user_code,  --商品名自定义码
        PHA_COM_BASEINFO.REGULAR_NAME as cus_name,  --通用名
      PHA_COM_BASEINFO.REGULAR_SPELL as cus_spell_code,  --通用名拼音码
       PHA_COM_BASEINFO.Regular_Custom /*'' */as cus_wb_code,  --通用名五笔码
       PHA_COM_BASEINFO.CUSTOM_CODE as cus_user_code,  --通用名自定义码
       PHA_COM_BASEINFO.Retail_Price as unit_price,
       PHA_COM_BASEINFO.Retail_Price as child_price,
       PHA_COM_BASEINFO.Retail_Price as sp_price,
       PHA_COM_BASEINFO.Pack_Unit as pack_unit,
       PHA_COM_BASEINFO.Min_Unit as min_unit,
       FUN_GET_STORE_DISPLAY(PHA_COM_STOCKINFO.STORE_SUM - NVL((SELECT SUM(P.APPLY_NUM) FROM pha_sto_preoutstore P WHERE P.DRUG_DEPT_CODE = PHA_COM_STOCKINFO.DRUG_DEPT_CODE
                                                            AND P.DRUG_CODE = PHA_COM_STOCKINFO.DRUG_CODE),0),
       PHA_COM_BASEINFO.Pack_Qty, PHA_COM_BASEINFO.Pack_Unit, PHA_COM_BASEINFO.Min_Unit) as now_store, --可用数量
       PHA_COM_STOCKINFO.DRUG_DEPT_CODE as exe_dept, --药房编码
       '' as gf_flag,
       PHA_COM_BASEINFO.USAGE_CODE as usage_code,   --用法编码
       PHA_COM_BASEINFO.FREQUENCY_CODE as freq_code,  --频次编码
       PHA_COM_BASEINFO.Dose_Unit as dose_unit,
       PHA_COM_BASEINFO.SPECIAL_FLAG as shenxz,
       PHA_COM_BASEINFO.SPECIAL_FLAG1 as shixz,
       PHA_COM_BASEINFO.SPECIAL_FLAG2 as zf,
       '' as needbespeak,
       PHA_COM_BASEINFO.BASE_DOSE as base_dose,
       PHA_COM_BASEINFO.Append_Flag as CONFIRM_FLAG,
       PHA_COM_BASEINFO.Split_Type as split_type,
       pha_com_stockinfo.valid_state as LACK_FLAG,
       '0' as Special_Check,
       pha_com_baseinfo.once_dose as once_dose,
       pha_com_baseinfo.other_name as other_name,
       '/' || pha_com_baseinfo.other_spell as other_spell,
       '' as default_sample,
       '' as other_name1,
       '' as other_name2,
       '' as other_name3,
       '' as spell_code1,
       '' as spell_code2,
       '' as spell_code3,
       '' as wb_code1,
       '' as wb_code2,
       '' as wb_code3,
       '' as input_code1,
       '' as input_code2,
       '' as input_code3,
       pha_com_baseinfo.international_code as YBGB_CODE,
       PHA_COM_BASEINFO.DRUG_QUALITY as QUALITY,
       '' as undrugitemmodel
FROM  PHA_STO_SETDEPT,
      PHA_COM_STOCKINFO,
      PHA_COM_BASEINFO
WHERE   PHA_COM_STOCKINFO.DRUG_DEPT_CODE = PHA_STO_SETDEPT.DEPT_CODE
AND   PHA_COM_STOCKINFO.Drug_Code      = PHA_COM_BASEINFO.Drug_Code
AND   PHA_COM_BASEINFO.VALID_STATE     = fun_get_valid
AND   PHA_COM_STOCKINFO.VALID_STATE    = fun_get_valid
AND   PHA_COM_BASEINFO.Nostrum_Flag = '0'
union all
select 'undrug' as dept_code,
       '2' as drug_flag,
       b.sys_class as sys_class,
       'fh' as fee_code,
       b.item_code as item_code,
       b.item_name as package_name,
       '' as en_name,
       1 as pack_qty,
       '' as specs,
       '' as dose_code,
       b.spell_code as spell_code,
       b.wb_code/*''*/ as wb_code,
       b.input_code as user_code,
       b.item_name as cus_name,
       b.spell_code as cus_spell_code,
       b.wb_code/*'' */as cus_wb_code,
       b.input_code as cus_user_code,
       (select sum(d.unit_price*c.qty) from fin_com_undrugztinfo c, fin_com_undruginfo d
       where   c.package_code = b.item_code
       and c.item_code = d.item_code
       and c.valid_state = '1' and d.valid_state = '1' /*and c.branch_code = 'ALL'*/) as unit_price,--不启用多院区,去掉院区判断 ji-t 2023.08.17
       (select sum(d.unit_price1*c.qty) from fin_com_undrugztinfo c, fin_com_undruginfo d
       where   c.package_code = b.item_code
       and c.item_code = d.item_code
       and c.valid_state = '1' and d.valid_state = '1' /*and c.branch_code = 'ALL'*/) as child_price,--不启用多院区,去掉院区判断 ji-t 2023.08.17
       (select sum(d.unit_price2*c.qty) from fin_com_undrugztinfo c, fin_com_undruginfo d
       where   c.package_code = b.item_code
       and c.item_code = d.item_code
       and c.valid_state = '1' and d.valid_state = '1' /*and c.branch_code = 'ALL'*/) as sp_price,--不启用多院区,去掉院区判断 ji-t 2023.08.17
       '次' as pack_unit,
       '次' as min_unit,
       '0' as now_store,
       nvl(b.exedept_code,'无') as exe_dept,
       '' as gf_flag,
       '' as usage_code,
       '' as freq_code,
       '' as dose_unit,
       '' as shenxz,
       '' as shixz,
       '' as zf,
       NEEDBESPEAK as needbespeak,
       1 as base_dose,
       nvl(b.confirm_flag,'0') as CONFIRM_FLAG,
       '0' as split_type,
       '0' as LACK_FLAG,
       '0' as Special_Check,
         0 as once_dose,
       '' as other_name,
       '' as other_spell,
       b.default_sample,
       b.other_name1 as other_name1,
       b.other_name2 as other_name2,
       b.other_name3 as other_name3,
       b.spell_code1 as spell_code1,
       b.spell_code2 as spell_code2,
       b.spell_code3 as spell_code3,
       b.wb_code1 as wb_code1,
       b.wb_code2 as wb_code2,
       b.wb_code3 as wb_code3,
       b.input_code1 as input_code1,
       b.input_code2 as input_code2,
       b.input_code3 as input_code3,
       b.ybgbgj_code as YBGB_CODE,
       '' as QUALITY,
       b.undrugitemmodel
from fin_com_undruginfo b
where b.valid_state = fun_get_valid
and b.UNITFLAG = '1' and b.applicabilityarea <> '2'
union all
select e.dept_code as dept_code,
       '3' as drug_flag,
       'group' as sys_class,
       '' as fee_code,
       e.group_id as item_code,
       e.group_name as item_name,
       e.group_id as en_name,
       1 as pack_qty,
       '' as specs,
       '' as dose_code,
       e.spell_code as spell_code,
       /*e.spell_code*/'' as wb_code,
       e.input_code  as user_code,
       e.group_name as cus_name,
       e.spell_code as cus_spell_code,
       /*e.spell_code*/'' as cus_wb_code,
       e.input_code as cus_user_code,
       0 as unit_price,
       0 as child_price,
       0 as sp_price,
        '次' as pack_unit,
       '次' as min_unit,
       '0' as now_store,
       nvl(e.DEPT_CODE,'无') as exe_dept,
       '' as gf_flag,
       '' as usage_code,
       '' as freq_code,
       '' as dose_unit,
       '' as shenxz,
       '' as shixz,
       '' as zf,
       '' as needbespeak,
       1 as base_dose,
      '0' as CONFIRM_FLAG,
      '0' as split_type,
      '0' as LACK_FLAG,
      '0' as Special_Check,
         0 as once_dose,
       '' as other_name,
        '' as other_spell,
        '' as default_sample,
       '' as other_name1,
       '' as other_name2,
       '' as other_name3,
       '' as spell_code1,
       '' as spell_code2,
       '' as spell_code3,
       '' as wb_code1,
       '' as wb_code2,
       '' as wb_code3,
       '' as input_code1,
       '' as input_code2,
       '' as input_code3,
       '' as YBGB_CODE,
       '' as QUALITY,
       '' as undrugitemmodel
from fin_com_group e
where  e.valid_flag = fun_get_valid
union all
SELECT PHA_STO_SETDEPT.ROOM_CODE as dept_code ,
       '4' as drug_flag, --药品标志协定处方
       PHA_COM_BASEINFO.Class_Code as sys_class,
        PHA_COM_BASEINFO.FEE_CODE as fee_code, --最小费用
       PHA_COM_BASEINFO.DRUG_CODE as item_code,      --药品编码
       (CASE WHEN PHA_COM_BASEINFO.REGULAR_NAME IS NOT NULL THEN PHA_COM_BASEINFO.REGULAR_NAME ELSE PHA_COM_BASEINFO.Trade_Name END) as item_name,    --药品名称【药品已经以通用名为主，因此此处改为优先取通用名20241105 shuai.liu_neu】
       PHA_COM_BASEINFO.English_Name as en_name, --英文名称
       PHA_COM_BASEINFO.PACK_QTY as pack_qty, --包装数量
       PHA_COM_BASEINFO.SPECS as specs, --药品规格
       PHA_COM_BASEINFO.DOSE_MODEL_CODE as dose_code,--剂型编码
       '/' || PHA_COM_BASEINFO.Spell_Code as spell_code, --商品名拼音码
       /*'/' || PHA_COM_BASEINFO.WB_CODE*/'' as wb_code, --商品名五笔码
       PHA_COM_BASEINFO.CUSTOM_CODE as user_code, --商品名自定义码
        PHA_COM_BASEINFO.REGULAR_NAME as cus_name, --通用名
       '/' || PHA_COM_BASEINFO.REGULAR_SPELL as cus_spell_code, --通用名拼音码
       /*'/' || PHA_COM_BASEINFO.Regular_Custom*/ '' as cus_wb_code, --通用名五笔码
       PHA_COM_BASEINFO.CUSTOM_CODE as cus_user_code, --通用名自定义码
       PHA_COM_BASEINFO.Retail_Price as unit_price,
       PHA_COM_BASEINFO.Retail_Price as child_price,
       PHA_COM_BASEINFO.Retail_Price as sp_price,
       PHA_COM_BASEINFO.Pack_Unit as pack_unit,
       PHA_COM_BASEINFO.Min_Unit as min_unit,
       FUN_GET_STORE_DISPLAY(PHA_COM_STOCKINFO.STORE_SUM - NVL((SELECT SUM(P.APPLY_NUMBER) FROM pha_sto_preoutstore P WHERE P.DRUG_DEPT_CODE = PHA_COM_STOCKINFO.DRUG_DEPT_CODE
                                                            AND P.DRUG_CODE = PHA_COM_STOCKINFO.DRUG_CODE),0),
       PHA_COM_BASEINFO.Pack_Qty, PHA_COM_BASEINFO.Pack_Unit, PHA_COM_BASEINFO.Min_Unit) as now_store, --可用数量
       PHA_COM_STOCKINFO.DRUG_DEPT_CODE as exe_dept, --药房编码
       '' as gf_flag,
       PHA_COM_BASEINFO.USAGE_CODE as usage_code,  --用法编码
       PHA_COM_BASEINFO.FREQUENCY_CODE as freq_code, --频次编码
       PHA_COM_BASEINFO.Dose_Unit as dose_unit,
       PHA_COM_BASEINFO.SPECIAL_FLAG as shenxz,
       PHA_COM_BASEINFO.SPECIAL_FLAG1 as shixz,
       PHA_COM_BASEINFO.SPECIAL_FLAG2 as zf,
       '' as needbespeak,
       PHA_COM_BASEINFO.BASE_DOSE as base_dose,
       PHA_COM_BASEINFO.Append_Flag as CONFIRM_FLAG,
       PHA_COM_BASEINFO.Split_Type as split_type,
       pha_com_stockinfo.valid_state as LACK_FLAG,
       '0' as Special_Check,
       pha_com_baseinfo.once_dose as once_dose,
       pha_com_baseinfo.other_name as other_name,
       '/' || pha_com_baseinfo.other_spell as other_spell,
       '' as default_sample,
       '' as other_name1,
       '' as other_name2,
       '' as other_name3,
       '' as spell_code1,
       '' as spell_code2,
       '' as spell_code3,
       '' as wb_code1,
       '' as wb_code2,
       '' as wb_code3,
       '' as input_code1,
       '' as input_code2,
       '' as input_code3,
       pha_com_baseinfo.international_code as YBGB_CODE,
       pha_com_baseinfo.Drug_Quality AS QUALITY,
       '' as undrugitemmodel
FROM    PHA_STO_SETDEPT,PHA_COM_BASEINFO,PHA_COM_STOCKINFO
WHERE   PHA_COM_STOCKINFO.DRUG_DEPT_CODE = PHA_STO_SETDEPT.DEPT_CODE
AND     PHA_COM_BASEINFO.VALID_STATE = fun_get_valid
AND     PHA_COM_STOCKINFO.VALID_STATE=fun_get_valid
AND     PHA_COM_STOCKINFO.DRUG_CODE=PHA_COM_BASEINFO.DRUG_CODE
AND     PHA_COM_BASEINFO.Nostrum_Flag = '1'
union all
--物资项目
select --a.storage_code as dept_code,
       'undrug' as dept_code,
       '6' as drug_flag,
       'UT' as sys_class, --系统类别
       b.fee_code as fee_code, --最小费用
       a.item_code as item_code, --编码
       a.item_name as package_name,--名称
       '' as en_name,
       1/*b.pack_qyt*/ as pack_qty, --包装数量
       b.specs as specs, --规格
       '' as dose_code,
       b.spell_code as spell_code, --拼音吗
       b.wb_code as wb_code, --五笔码
       b.custom_code as user_code, --自定义码
       a.item_name as cus_name,
       b.spell_code as cus_spell_code,
       b.wb_code as cus_wb_code,
       b.custom_code as cus_user_code,
       a.avg_saleprice as unit_price, --零售价
       a.avg_saleprice as child_price,
       a.avg_saleprice as sp_price,
       b.stat_unit/*b.pack_unit*/ as pack_unit, --大包装单位
       b.stat_unit as min_unit, --小包装单位
       to_char(a.store_num) as now_store, --库存
       a.storage_code as exe_dept, --执行科室
       '' as gf_flag,
       '' as usage_code,
       '' as freq_code,
       '' as dose_unit,
       '' as shenxz,
       '' as shixz,
       '' as zf,
       '' as needbespeak,
       1 as base_dose,
       '0' as CONFIRM_FLAG,
       '0' as split_type,
       a.lack_flag as LACK_FLAG, --缺药标志
       '0' as Special_Check,
       0 as once_dose,
       '' as other_name,
       '' as other_spell,
       '' as default_sample,
       '' as other_name1,
       '' as other_name2,
       '' as other_name3,
       '' as spell_code1,
       '' as spell_code2,
       '' as spell_code3,
       '' as wb_code1,
       '' as wb_code2,
       '' as wb_code3,
       '' as input_code1,
       '' as input_code2,
       '' as input_code3,
       '' as YBGB_CODE,
       '' as QUALITY,
       '' as undrugitemmodel
  from log_mat_stockinfo a,log_mat_baseinfo b
 where a.item_code = b.item_code
  --and a.item_code in (select b.item_code from log_mat_baseinfo b where b.finance_flag = '1' and b.valid_flag = fun_get_valid)
  and b.finance_flag = '1' and b.valid_flag = fun_get_valid
  );


/*==========SQL手动执行==========*/
----------HIS-22001----------
--SQL手动执行：Fee.QueryMedItemListsForListMulti
declare
lv com_sql.name%type;
begin
lv:= '  SELECT distinct i.recipe_no, --处方号
       i.sequence_no, --处方内项目流水号
       i.trans_type, --交易类型,1正交易，2反交易
       i.inpatient_no, --住院流水号
       i.name, --姓名
       i.paykind_code, --结算类别 01-自费  02-保险 03-公费在职 04-公费退休 05-公费高干
       i.pact_code, --合同单位
       i.update_sequenceno, --更新库存的流水号  ---------7
       i.inhos_deptcode, --在院科室代码
       i.nurse_cell_code, --护士站代码
       i.recipe_deptcode, --开立科室代码
       i.execute_deptcode, --执行科室代码
       i.medicine_deptcode, --取药科室代码
       i.recipe_doccode, --开立医师代码
       i.drug_code, --药品编码
       i.fee_code, --最小费用代码
       i.center_code, --医疗中心项目代码
       i.drug_name, --药品名称-----------------------17
       i.unit_price, --单价
       i.qty, --数量
       i.current_unit, --当前单位
       i.pack_qty, --包装数---------------------------
       i.days, --付数----------------------------
       i.tot_cost, --费用金额
       i.own_cost, --自费金额
       i.pay_cost, --自付金额
       i.pub_cost, --公费金额
       i.eco_cost, --优惠金额
       i.senddrug_sequence, --发药单序列号
       i.senddrug_flag, --发药状态（0 划价 2摆药 1批费）
       i.baby_flag, --是否婴儿用药 0 不是 1 是
       i.jzqj_flag, --急诊抢救标志
       i.brought_flag, --出院带药标记 0 否 1 是
       i.invoice_no, --结算发票号
       i.balance_no, --结算序号
       i.apprno, --审批号
       i.charge_opercode, --划价人
       i.charge_date, --划价日期---------------------------37
       i.home_made_flag, --自制标识---------
       i.drug_quality, --药品性质-----------
       i.senddrug_opercode, --发药人
       i.senddrug_date, --发药日期
       i.fee_opercode, --计费人
       i.fee_date, --计费时间
       i.check_opercode, --审核人
       i.check_no, --审核序号
       i.mo_order, --医嘱流水号
       i.mo_exec_sqn, --医嘱执行单流水号
       i.specs, --规格---------------
       i.drug_type, --药品类别----------------
       i.NOBACK_NUM,
       i.balance_state,
       i.fee_rate,
       i.FEEOPER_DEPTCODE,
       i.EXT_FLAG, --扩展标记
       i.EXT_FLAG1, --扩展标记1
       i.EXT_FLAG2, --扩展标记2
       i.EXT_CODE, --扩展编码
       i.EXT_OPERCODE, --扩展人员编码
       i.EXT_DATE ,--扩展日期
       i.medicalteam_code,
       i.operationno,  --手术编码
       i.charge_doct,
       i.charge_medicalteam,
       i.ext_flag3,
       i.his_cancel_recipe_no,
       i.his_cancel_recipe_sequence_no,
       i.long_flag,
       i.own_flag,
       i.sy_owncost,
       i.sy_paycost,
       e.comb_no ,
       e.sort_id,
       e.use_time,
       --(select mi1.comb_no from met_ipm_execdrug mi1 where mi1.exec_sqn = i.mo_exec_sqn) comb_mo,
     --  (select mi1.sort_id from met_ipm_execdrug mi1 where mi1.exec_sqn = i.mo_exec_sqn) sort_id,
      -- (select mi1.use_time from met_ipm_execdrug mi1 where mi1.exec_sqn = i.mo_exec_sqn) use_time
       fun_get_dept_name(recipe_deptcode), --开方科室名称
       t.nurse_apply_bill,
       --,(select t.nurse_apply_bill from pha_com_applyout t where t.exec_sqn=i.mo_exec_sqn and t.class3_meaning_code=''Z1'' and t.valid_state = ''1'' group by t.nurse_apply_bill) nurse_apply_bill,
       (select d.name from com_dictionary d where d.code = i.fee_code and d.type = ''MINFEE'') FEE_NAME,
       fun_chk_get_querycode(i.drug_name,1) spell_code,
       (select k.type_name from met_ipm_kind k  where k.type_code =(select mi1.type_code from met_ipm_execdrug mi1 where mi1.exec_sqn = i.mo_exec_sqn )),
        fun_get_dept_name(execute_deptcode),
        e.decmps_state,
        --(select k.decmps_state from met_ipm_kind k  where k.type_code =(select mi1.type_code from met_ipm_execdrug mi1 where mi1.exec_sqn = i.mo_exec_sqn ))
         fun_get_employee_name(recipe_doccode),
         i.selfmade_guid,
         e.drug_name,
         e.exec_date
       ,e.exec_usercd -- 执行人编码
       ,mio.mo_date
       ,mio.date_bgn
       ,mio.mo_note2 --医生医嘱备注
  FROM fin_ipb_medicinelist i
  left join pha_com_applyout t on t.exec_sqn = i.mo_exec_sqn and t.valid_state = ''1'' and t.class3_meaning_code=''Z1''
   left join met_ipm_execdrug e on e.exec_sqn = i.mo_exec_sqn
   left join met_ipm_order mio on mio.mo_order = e.mo_order
  WHERE  i.trans_type =1
         AND i.inpatient_no in ({0})
           AND i.fee_date >=to_date(''{1}'',''yyyy-mm-dd hh24:mi:ss'')
           AND i.fee_date <=to_date(''{2}'',''yyyy-mm-dd hh24:mi:ss'')
           AND i.senddrug_flag in({3})
           AND i.NOBACK_NUM>0
           AND i.BALANCE_STATE=''{4}''

           ORDER BY e.use_time, e.comb_no,e.sort_id
                                                                                                                                                                                                                                                                                                                    ';
update com_sql a set a.name = lv where a.id = 'Fee.QueryMedItemListsForListMulti';
commit;
end;

```

OWNER	HIS50	varchar2(128), optional, Username of the owner of the object
OBJECT_NAME	TRG_COM_PATIENTINFO_INSERT	varchar2(128), optional, Name of the object
SUBOBJECT_NAME		varchar2(128), optional, Name of the sub-object (for example, partititon)
OBJECT_ID	100714	number, optional, Object number of the object
DATA_OBJECT_ID		number, optional, Object number of the segment which contains the object
OBJECT_TYPE	TRIGGER	varchar2(23), optional, Type of the object
CREATED	2025/4/14 11:51:33	date, optional, Timestamp for the creation of the object
LAST_DDL_TIME	2025/6/29 10:26:41	date, optional, Timestamp for the last DDL change (including GRANT and REVOKE) to the object
TIMESTAMP	2025-06-29:10:26:41	varchar2(19), optional, Timestamp for the specification of the object
STATUS	INVALID	varchar2(7), optional, Status of the object
TEMPORARY	N	varchar2(1), optional, Can the current session only see data that it place in this object itself?
GENERATED	N	varchar2(1), optional, Was the name of this object system generated?
SECONDARY	N	varchar2(1), optional, Is this a secondary object created as part of icreate for domain indexes?
NAMESPACE	3	number, optional, Namespace for the object
EDITION_NAME		varchar2(128), optional, Name of the edition in which the object is actual
SHARING	NONE	varchar2(18), optional, Is this a Metadata Link, an Object Link or neither?
EDITIONABLE	Y	varchar2(1), optional, Object is considered editionable
ORACLE_MAINTAINED	N	varchar2(1), optional, Denotes whether the object was created, and is maintained, by Oracle-supplied scripts. An object for which this has the value Y must not be changed in any way except by running an Oracle-supplied script.
APPLICATION	N	varchar2(1), optional, Denotes whether the object is part of an Application Container.
DEFAULT_COLLATION	USING_NLS_COMP	varchar2(100), optional, Default collation for the object
DUPLICATED	N	varchar2(1), optional
SHARDED	N	varchar2(1), optional
CREATED_APPID		number, optional, ID of Application that created object
CREATED_VSNID		number, optional, ID of Application Version that created object
MODIFIED_APPID		number, optional, ID of Application that last modified object
MODIFIED_VSNID		number, optional, ID of Application Version that last modified object